# PDSA: MCP Server as Mindspace Infrastructure Layer

**PDSA ID:** 2026-02-02-UTC-1500.mcp-server-infrastructure-layer
**Project:** xpollination-mindspace (tracking) / xpollination-mcp-server (implementation)
**Status:** PLAN
**Created:** 2026-02-02
**Priority:** HIGH — Defines the programmatic enforcement layer for the mindspace process
**Agent:** PDSA Agent
**Parent PDSA:** 2026-02-02-UTC-1300.mindspace-vision.pdsa.md (Section 4.4: Three-Actor Model)

---

## MANAGEMENT ABSTRACT

**What:** Extend the xpollination-mcp-server to serve as the infrastructure layer (state machine) for the mindspace — the programmatic layer that enforces node transitions, quality gates, and agent permissions, replacing trust-based YAML editing.

**Why:** The mindspace vision (iteration 3) identified that YAML-editing-by-agents is fragile — any agent can bypass process. Thomas's three-actor model requires a programmatic layer where the node defines WHAT, infrastructure enforces HOW, and agents are zero-knowledge workers. The MCP server already has a WorkflowEngine, state machine, and SQLite database — it is the natural home for this enforcement layer.

**Outcome:** An MCP server that:
1. Manages mindspace nodes as first-class entities (CRUD + state transitions)
2. Enforces valid state transitions programmatically (no agent can skip gates)
3. Exposes station-scoped APIs (agents only see/act on nodes in their station's state)
4. Validates DoR before allowing work to start, validates DoD before allowing completion

---

## Thomas's Direction (Verbatim — 2026-02-02)

> "YES! I also see the MCP as the infrastructure level! Exactly. We are bootstrapping the process now and documenting it and then we are implementing it. So we have now an example where we have 2 different projects that are in the same mindspace. Mindspace itself and MCP server. Based on that understanding create or update the PDSA for the MCP server in the right project and then return with a mock-up of the current mindspace. We can then iterate it as if the product already exists. Let's simulate the process and then learn from that process and then create the first iteration of it."

---

## PLAN

### 1. Current MCP Server State

The xpollination-mcp-server already has infrastructure that maps to the mindspace needs:

| Existing Component | Current Purpose | Mindspace Purpose |
|-------------------|----------------|-------------------|
| `WorkflowEngine.ts` | Content pipeline state machine | Generalizes to mindspace node state machine |
| `states.ts` | Content pipeline states (draft, review, published) | Extends to node lifecycle states (pending, active, complete, etc.) |
| `transitions.ts` | Valid state transitions for content | Extends to node transitions with DoR/DoD validation |
| SQLite database | Frames, drafts, trends | Extends with `nodes` table for mindspace state |
| MCP tools | Content pipeline tools (crawl, write, fact_check) | Adds mindspace tools (get_ready_nodes, submit_output, book_transition) |
| MCP resources | Content resources (frames, drafts) | Adds mindspace resources (node tree, scope stack) |

### 2. The Two Domains

The MCP server serves two distinct domains that share infrastructure:

```
xpollination-mcp-server
├── Content Pipeline (existing)
│   ├── Tools: crawl_trends, propose_topic, write_draft, fact_check, publish_post
│   ├── Workflow: content-specific state machine
│   └── Data: frames, drafts, trends, published_posts
│
└── Mindspace Infrastructure (new)
    ├── Tools: mindspace_get_nodes, mindspace_submit_output, mindspace_book_transition
    ├── Workflow: node lifecycle state machine with DoR/DoD enforcement
    └── Data: nodes, transitions, quality_gate_results
```

Both domains use the same WorkflowEngine pattern. The content pipeline is itself a station in the mindspace — content nodes flow through content pipeline stations.

### 3. Mindspace API Surface

#### 3.1 Node Query Tools (Read — Any Agent)

```typescript
// Get nodes visible to a specific station/agent
mindspace_get_ready_nodes({
  station: "dev",           // Only nodes whose DoR is satisfied AND assigned to dev
  status: "active",         // Filter by status
  parent_id?: string        // Scope to a branch
})
// Returns: node[] with full context (DoR, DoD, parent path, inputs available)

// Get full tree or subtree
mindspace_get_tree({
  root_id?: string,         // Subtree root (default: full tree)
  depth?: number            // Max depth to return
})
// Returns: recursive node tree

// Get scope stack (where is human attention?)
mindspace_get_scope_stack()
// Returns: ordered node IDs from root to active focus
```

#### 3.2 Node Action Tools (Write — Constrained Per Station)

```typescript
// Submit work output for a node
mindspace_submit_output({
  node_id: string,
  outputs: [{
    type: "file" | "state" | "analysis",
    description: string,
    path?: string
  }]
})
// Infrastructure validates: Is this node in a state where outputs are accepted?
// Infrastructure validates: Does the agent have permission for this node?
// Returns: { accepted: boolean, validation_errors?: string[] }

// Request a state transition
mindspace_book_transition({
  node_id: string,
  target_state: string      // e.g., "complete"
})
// Infrastructure validates: Are all DoD quality gates passed?
// Infrastructure validates: Are all required outputs present?
// Infrastructure validates: Is this transition valid from current state?
// Returns: { transitioned: boolean, blocked_by?: string[] }
```

#### 3.3 Node Management Tools (Write — Orchestrator/PDSA Only)

```typescript
// Create a new node in the tree
mindspace_create_node({
  parent_id: string,
  title: string,
  owner: string,
  type: string,
  definition_of_ready: { context, inputs },
  definition_of_done: { action, acceptance, quality_gates, outputs }
})
// Infrastructure validates: Does parent exist? Is node schema valid?

// Update scope stack (human attention)
mindspace_set_focus({
  node_id: string           // The node to focus on
})
// Infrastructure computes scope_stack from root to this node
```

### 4. State Machine: Node Lifecycle

```
                    ┌─────────┐
                    │ pending │ ← Created, DoR not yet satisfied
                    └────┬────┘
                         │ DoR satisfied (all inputs available)
                         ▼
                    ┌─────────┐
          ┌────────│  ready  │ ← Waiting for agent to pick up
          │        └────┬────┘
          │             │ Agent starts work
          │             ▼
          │        ┌─────────┐
          │        │ active  │ ← Work in progress
          │        └────┬────┘
          │             │ Outputs submitted
          │             ▼
          │        ┌──────────┐
          │        │ review   │ ← DoD validation in progress
          │        └────┬─────┘
          │            ╱ ╲
          │           ╱   ╲
          │     pass ╱     ╲ fail
          │         ╱       ╲
          │        ▼         ▼
          │   ┌──────────┐  ┌─────────┐
          │   │ complete │  │ rework  │──→ back to active
          │   └──────────┘  └─────────┘
          │
          │   (scope break discovered)
          │        ▼
          │   ┌─────────┐
          └──→│ paused  │ ← Suspended while child PDSA runs
              └─────────┘
```

**Key enforcement rules:**
- `pending → ready`: Automatic when all `definition_of_ready.inputs` are available
- `ready → active`: Only the assigned agent (owner) can start
- `active → review`: Only when outputs are submitted via `mindspace_submit_output`
- `review → complete`: Only when ALL `definition_of_done.quality_gates` pass
- `review → rework`: When any quality gate fails — agent must fix and resubmit
- No agent can jump directly to `complete` — the infrastructure enforces the full lifecycle

### 5. Data Model Extension

```sql
-- New tables for mindspace (extend existing SQLite schema)

CREATE TABLE mindspace_nodes (
  id TEXT PRIMARY KEY,
  parent_id TEXT REFERENCES mindspace_nodes(id),
  title TEXT NOT NULL,
  owner TEXT NOT NULL,
  type TEXT NOT NULL DEFAULT 'task',
  status TEXT NOT NULL DEFAULT 'pending',
  pdsa_phase TEXT,
  pdsa_ref_git_url TEXT,
  pdsa_ref_local_path TEXT,
  dor_context TEXT,
  dor_status TEXT NOT NULL DEFAULT 'not_ready',
  dod_action TEXT,
  dod_acceptance TEXT,
  dod_status TEXT NOT NULL DEFAULT 'not_done',
  sort_order INTEGER NOT NULL DEFAULT 0,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE mindspace_node_inputs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  node_id TEXT NOT NULL REFERENCES mindspace_nodes(id),
  from_node_id TEXT NOT NULL,
  type TEXT NOT NULL,          -- file | state | analysis
  description TEXT,
  path TEXT,
  satisfied BOOLEAN NOT NULL DEFAULT 0
);

CREATE TABLE mindspace_node_outputs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  node_id TEXT NOT NULL REFERENCES mindspace_nodes(id),
  type TEXT NOT NULL,
  description TEXT,
  path TEXT,
  produced BOOLEAN NOT NULL DEFAULT 0
);

CREATE TABLE mindspace_quality_gates (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  node_id TEXT NOT NULL REFERENCES mindspace_nodes(id),
  name TEXT NOT NULL,
  status TEXT NOT NULL DEFAULT 'pending',  -- pending | pass | fail
  verifier TEXT NOT NULL
);

CREATE TABLE mindspace_transitions (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  node_id TEXT NOT NULL REFERENCES mindspace_nodes(id),
  from_status TEXT NOT NULL,
  to_status TEXT NOT NULL,
  triggered_by TEXT NOT NULL,  -- agent ID or "system"
  reason TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE mindspace_scope_stack (
  position INTEGER PRIMARY KEY,
  node_id TEXT NOT NULL REFERENCES mindspace_nodes(id)
);
```

### 6. Implementation Phases

| Phase | What | Depends On |
|-------|------|-----------|
| **M.1** | Add `mindspace_nodes` table + repository to existing SQLite DB | Vision PDSA approved |
| **M.2** | Extend WorkflowEngine with node lifecycle states and transitions | M.1 |
| **M.3** | Implement `mindspace_get_ready_nodes` and `mindspace_get_tree` tools | M.1 |
| **M.4** | Implement `mindspace_submit_output` with DoD validation | M.2 |
| **M.5** | Implement `mindspace_book_transition` with full enforcement | M.2 |
| **M.6** | Implement `mindspace_create_node` and `mindspace_set_focus` | M.1 |
| **M.7** | Migration: import mock-up YAML into SQLite as initial data | M.1, mock-up exists |
| **M.8** | Integration test: simulate a full node lifecycle via MCP tools | M.3–M.6 |

### 7. Quality Gates

| Gate | Criteria | Verifier |
|------|----------|----------|
| QG-1 | No agent can transition a node to "complete" without all quality gates passing | pdsa-agent |
| QG-2 | Agent at station X only sees nodes assigned to station X in the correct state | pdsa-agent |
| QG-3 | All state transitions are logged in `mindspace_transitions` table | pdsa-agent |
| QG-4 | WorkflowEngine reuse: new node lifecycle uses same engine as content pipeline | pdsa-agent |
| QG-5 | Mock-up YAML can be imported as initial data | pdsa-agent |
| QG-6 | Thomas approves API surface as matching his vision | thomas |

---

## DO

*Pending approval. Dev agent implements M.1–M.8 after Thomas approves.*

---

## STUDY

*Pending implementation.*

---

## ACT

*Pending.*

---

## REFERENCES

### Dual-Links

| Document | Git URL | Local Path |
|----------|---------|------------|
| Vision PDSA | `https://github.com/PichlerThomas/xpollination-mindspace/blob/main/docs/pdsa/2026-02-02-UTC-1300.mindspace-vision.pdsa.md` | `/home/developer/workspaces/github/PichlerThomas/xpollination-mindspace/docs/pdsa/2026-02-02-UTC-1300.mindspace-vision.pdsa.md` |
| This PDSA | `https://github.com/PichlerThomas/xpollination-mindspace/blob/main/docs/pdsa/2026-02-02-UTC-1500.mcp-server-infrastructure-layer.pdsa.md` | `/home/developer/workspaces/github/PichlerThomas/xpollination-mindspace/docs/pdsa/2026-02-02-UTC-1500.mcp-server-infrastructure-layer.pdsa.md` |
| MCP Server Repo | `https://github.com/PichlerThomas/xpollination-mcp-server` | `/home/developer/workspaces/github/PichlerThomas/xpollination-mcp-server` |
| MCP Server CLAUDE.md | `https://github.com/PichlerThomas/xpollination-mcp-server/blob/main/CLAUDE.md` | `/home/developer/workspaces/github/PichlerThomas/xpollination-mcp-server/CLAUDE.md` |
